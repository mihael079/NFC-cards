<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Persona</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffbe3c" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --gold:#ffbe3c; --cream:#fff8e1; --ink:#2a2a2a; --paper:#fffdf5; --border:#efe7da;
      --soft:0 10px 30px rgba(0,0,0,.10); --soft-2:0 6px 18px rgba(0,0,0,.08);
      --ring:0 0 0 4px rgba(255,190,60,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(135deg, var(--cream), #fdebe6);
      color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-tap-highlight-color: transparent;
    }

    .topbar{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg, var(--gold), #ffc84d);
      color:#3f2f2a; box-shadow:var(--soft); padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .topbar h1{margin:0; font-size:1.1rem; font-weight:900; letter-spacing:.2px}
    .topbar a{color:#3f2f2a; text-decoration:none; font-weight:800}

    .layout{max-width:1100px; margin:16px auto; padding:16px}

    /* Hero */
    .hero{
      background:
        radial-gradient(100% 120% at 20% -30%, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(120% 120% at 50% -10%, #fff3d4 0%, #ffe9b3 55%, var(--gold) 100%);
      border-radius:22px; padding:18px; box-shadow:var(--soft); border:1px solid #ffe7b4;
    }
    .hero .title{margin:0 0 6px; font-weight:900; font-size:clamp(1.25rem,2.8vw,1.9rem)}
    .hero .who{margin:4px 0 0; font-weight:800; color:#4b342c}

    /* Toolbar */
    .toolbar{
      margin-top:14px; display:flex; flex-wrap:wrap; gap:10px;
      background:#fff; border:1px solid var(--border); border-radius:14px; padding:10px; box-shadow:var(--soft-2);
      align-items:center;
    }
    .toolbar select, .toolbar input{
      appearance:none; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; font-weight:700; color:#333; background:#fff; min-height:40px;
    }
    .toolbar select:focus, .toolbar input:focus{outline:none; box-shadow:var(--ring)}
    .toolbar .spacer{flex:1 1 auto}

    /* Program sections */
    .program{ margin-top:20px; padding-top:10px; border-top:1px dashed #e9dfcf; }
    .program h3{
      margin:0 0 10px; font-size:1.05rem; font-weight:900; color:#2e241f; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }

    /* Grid */
    .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    @media (max-width:480px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    /* Card + flipping (same class names as persona-cards page) */
    .card{ position:relative; width:100%; aspect-ratio: 100 / 140; perspective:1000px; }
    .cardInner{ position:absolute; inset:0; transition:transform .6s; transform-style:preserve-3d;
      border-radius:14px; overflow:hidden; border:1px solid var(--border); background:#fff; box-shadow:var(--soft-2); }
    .card.flipped .cardInner{ transform: rotateY(180deg); }

    .cardFront, .cardBack{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; backface-visibility:hidden; border-radius:14px; display:block;
    }
    .cardFront{ transform: rotateY(0deg); z-index:2; }
    .cardBack { transform: rotateY(180deg); }

    .empty{ margin:12px 0; background:var(--paper); border:1px dashed var(--border); border-radius:14px; padding:18px; text-align:center; color:#6b7280; }

    .sr-only{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
      clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>My Persona</h1>
    <a href="index.html" aria-label="Back to Home"><i class="fa-solid fa-cards-blank"></i> Back</a>
  </div>

  <div class="layout">
    <section class="hero" aria-label="Persona intro">
      <h2 class="title">Your Persona Cards</h2>
      <div id="who" class="who" aria-live="polite"></div>

      <div class="toolbar" role="toolbar" aria-label="Filters">
        <label>
          <span class="sr-only">Program</span>
          <select id="filterProgram" title="Program">
            <option value="">All programs</option>
          </select>
        </label>

        <label>
          <span class="sr-only">Face</span>
          <select id="filterFace" title="Face">
            <option value="both">Front & Back (flip)</option>
            <option value="front">Front only</option>
            <option value="back">Back only</option>
          </select>
        </label>

        <label class="spacer">
          <span class="sr-only">Search by ID</span>
          <input id="filterSearch" type="search" placeholder="Search card id…" />
        </label>
      </div>
    </section>

    <div id="programsWrap"></div>
    <div id="emptyAll" class="empty" style="display:none;">No cards match your filters.</div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref as dbRef, get } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBEIGffCj6b7RTU0hjW8Z4BXlrzFVZFL-s",
      authDomain: "nfc-cards-dfa6b.firebaseapp.com",
      projectId: "nfc-cards-dfa6b",
      storageBucket: "nfc-cards-dfa6b.appspot.com",
      messagingSenderId: "321725769305",
      appId: "1:321725769305:web:42e79fd85cc6029b97f348",
      databaseURL: "https://nfc-cards-dfa6b-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Elements
    const who = document.getElementById('who');
    const programsWrap = document.getElementById('programsWrap');
    const emptyAll = document.getElementById('emptyAll');
    const filterProgram = document.getElementById('filterProgram');
    const filterFace = document.getElementById('filterFace');
    const filterSearch = document.getElementById('filterSearch');

    // State
    let USER_FOLDER = '';          // from users/{uid}.displayName (e.g., "MIHF")
    let PERSONA = { programs: [] };

    const safePrograms = () => Array.isArray(PERSONA?.programs) ? PERSONA.programs : [];

    // Build a flipping card (front/back) using the same class names as persona-cards
    function makeFlipCard(frontSrc, backSrc, id, faceMode){
      const card = document.createElement('div');
      card.className = 'card';
      const inner = document.createElement('div');
      inner.className = 'cardInner';

      let frontOk = false, backOk = false;

      const updateFlip = () => {
        const canFlip = (faceMode === 'both' && frontOk && backOk);
        if (canFlip){
          card.onclick = () => card.classList.toggle('flipped');
        } else {
          card.onclick = null;
          card.classList.remove('flipped');
        }
      };

      if (faceMode !== 'back'){
        const f = document.createElement('img');
        f.className = 'cardFront';
        f.alt = `Card ${id} front`;
        f.src = frontSrc;
        f.addEventListener('load',  () => { frontOk = true;  updateFlip(); });
        f.addEventListener('error', () => { f.remove(); frontOk = false; updateFlip(); });
        inner.appendChild(f);
      }

      if (faceMode !== 'front'){
        const b = document.createElement('img');
        b.className = 'cardBack';
        b.alt = `Card ${id} back`;
        b.src = backSrc;
        b.addEventListener('load',  () => { backOk = true;  updateFlip(); });
        b.addEventListener('error', () => { b.remove(); backOk = false; updateFlip(); });
        inner.appendChild(b);
      }

      card.appendChild(inner);
      // Initial check (helps with cached images)
      updateFlip();
      return card;
    }

    function renderProgramSection(program, ids){
      const holder = document.createElement('section');
      holder.className = 'program';
      const h = document.createElement('h3');
      h.innerHTML = `<i class="fa-solid fa-circle-dot" aria-hidden="true"></i> ${program.name}`;
      holder.appendChild(h);

      if (!ids.length){
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No cards here with current filters.';
        holder.appendChild(empty);
        return holder;
      }

      const grid = document.createElement('div');
      grid.className = 'grid';
      const faceMode = filterFace.value;

      for (const id of ids){
        const front = `${USER_FOLDER}/card${id}front.png`;
        const back  = `${USER_FOLDER}/card${id}back.png`;
        grid.appendChild(makeFlipCard(front, back, id, faceMode));
      }

      holder.appendChild(grid);
      return holder;
    }

    function populateProgramFilter(){
      filterProgram.innerHTML = '<option value="">All programs</option>';
      for (const p of safePrograms()){
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        filterProgram.appendChild(opt);
      }
    }

    function applyFilters(){
      const progId = filterProgram.value;      // '' or program id
      const term = filterSearch.value.trim();  // substring of id

      programsWrap.innerHTML = '';
      let anyShown = false;

      for (const p of safePrograms()){
        if (progId && p.id !== progId) continue;

        const ids = (p.cards || []).filter(id => !term || String(id).includes(term));
        programsWrap.appendChild(renderProgramSection(p, ids));
        if (ids.length) anyShown = true;
      }

      emptyAll.style.display = anyShown ? 'none' : 'block';
    }

    async function loadPersonaJson(){
      let data = null;
      const res = await fetch('persona.json', { cache:'no-store' });
      if (!res.ok) throw new Error(`persona.json HTTP ${res.status}`);
      data = await res.json();
      if (!Array.isArray(data?.programs)) throw new Error('persona.json missing "programs" array');
      PERSONA = data;
    }

    async function bootstrap(){
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.replace('login.html');
          return;
        }
        const uid = user.uid;

        // Resolve folder from DB (displayName as folder)
        const snap = await get(dbRef(db, `users/${uid}`));
        if (!snap.exists()){
          who.textContent = 'User record not found.';
          return;
        }
        const u = snap.val();
        USER_FOLDER = (u.displayName || '').trim();
        if (!USER_FOLDER){
          who.textContent = 'No display name/folder set for your account.';
          return;
        }
        who.textContent = `Folder: ${USER_FOLDER}`;

        // Load program mapping and render
        try{
          await loadPersonaJson();
        } catch(err){
          who.textContent = `Folder: ${USER_FOLDER} • persona.json missing/invalid`;
          PERSONA = { programs: [] };
        }

        populateProgramFilter();
        applyFilters();

        // Filters
        filterProgram.addEventListener('change', applyFilters);
        filterFace.addEventListener('change', applyFilters);
        filterSearch.addEventListener('input', applyFilters);
      });
    }

    bootstrap();
  </script>
</body>
</html>
