<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Playground – Activities</title>
  <meta name="theme-color" content="#ffbe3c" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --gold:#ffbe3c;
      --brown:#5d4037;
      --ink:#2a2a2a;
      --cream:#fff8e1;
      --paper:#fffdf5;
      --border:#efe7da;
      --ring: 0 0 0 4px rgba(255,190,60,.25);

      --soft-shadow:0 10px 30px rgba(0,0,0,.10);
      --soft-2:0 6px 18px rgba(0,0,0,.08);

      --chip-blue:#e3f2fd;
      --chip-green:#e7f6ea;
      --chip-orange:#fff3e0;
      --chip-gray:#f3f4f6;
      --chip-red:#ffe4e6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(135deg, var(--cream), #fdebe6);
      color:var(--ink);
      -webkit-tap-highlight-color: transparent;
    }

    /* Topbar */
    .topbar{
      position: sticky; top: 0; z-index: 5;
      background: linear-gradient(180deg, var(--gold), #ffc84d);
      color: #3f2f2a;
      box-shadow: var(--soft-shadow);
      padding: 10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .topbar h1{margin:0; font-size:1.1rem; font-weight:900; letter-spacing:.2px}
    .topbar a{color:#3f2f2a; text-decoration:none; font-weight:800}

    .layout{max-width:1100px; margin:16px auto; padding:16px}

    /* Hero / Intro */
    .hero{
      background:
        radial-gradient(100% 120% at 20% -30%, rgba(255,255,255,.65) 0%, rgba(255,255,255,.0) 60%),
        radial-gradient(120% 120% at 50% -10%, #fff3d4 0%, #ffe9b3 55%, var(--gold) 100%);
      border-radius:22px; padding:18px; box-shadow: var(--soft-shadow);
      border:1px solid #ffe7b4;
    }
    .hero .title{
      margin:0 0 8px;
      font-weight:900;
      font-size: clamp(1.25rem, 2.8vw, 1.9rem);
      color:#3f2f2a;
      letter-spacing:.2px;
    }
    .hero .subtitle{
      margin:0 0 14px;
      color:#6a5248;
      font-size: clamp(.95rem, 2vw, 1.05rem);
      line-height:1.45;
    }
    .hero .stats{display:flex; gap:10px; flex-wrap:wrap}
    .stat{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 12px; box-shadow: var(--soft-2);
      font-weight:800; color:#4b5563; display:flex; align-items:center; gap:8px;
    }

    /* Sections */
    .section{margin-top:20px}
    .section h3{
      margin:0 0 12px; font-size:1.05rem; font-weight:900; color:#3f2f2a; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .section h3 .sec-ico{font-size:1rem; opacity:.8}

    /* Responsive grid */
    .grid{
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }

    /* Card */
    .card{
      background:#fff; border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow: var(--soft-2);
      display:flex; flex-direction:column; min-height: 260px;
      transition: transform .08s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 16px 28px rgba(0,0,0,.12); }

    /* Poster (image area) */
    .poster{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;                 /* uniform, responsive */
      background:linear-gradient(135deg, #ffe7c1, #ffd78a);
      overflow:hidden;
      isolation:isolate;
    }
    .poster img{
      width:100%; height:100%; object-fit:cover; display:block;
      transform: scale(1.001);
    }
    .poster::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to top, rgba(0,0,0,.28), rgba(0,0,0,0) 60%);
      pointer-events:none;
      z-index: 1;
    }

    /* Status badge */
    .badge{
      position:absolute; top:10px; left:10px; z-index:2;
      background:#000000a0; color:#fff; font-weight:800; font-size:.75rem; padding:6px 8px; border-radius:999px;
      display:flex; gap:6px; align-items:center; text-transform:capitalize;
      backdrop-filter: blur(2px);
    }

    /* Card content */
    .content{padding:12px 14px; display:flex; flex-direction:column; gap:8px; flex:1}
    .title{font-weight:900; font-size:1.02rem; color:#2e241f; margin:0}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      font-size:.78rem; font-weight:800; padding:6px 8px; border-radius:999px;
      background:var(--chip-gray); color:#374151; border:1px solid #e5e7eb;
    }
    .chip.green{background:var(--chip-green); color:#14532d; border-color:#cde7d4}
    .chip.orange{background:var(--chip-orange); color:#8a3d00; border-color:#ffd6a6}
    .chip.blue{background:var(--chip-blue); color:#0b5394; border-color:#cfe4fb}
    .chip.red{background:var(--chip-red); color:#7f1d1d; border-color:#fecaca}

    /* Buttons */
    .actions{display:flex; gap:8px; margin-top:auto}
    .btn{
      flex:1; min-height:40px; border-radius:12px; border:2px solid #00000012;
      background:#fff; color:#333; font-weight:900; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition: transform .1s ease, box-shadow .2s ease;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 8px 16px rgba(0,0,0,.12)}
    .btn.join{background:#1e88e5; color:#fff; border-color:#1669b5}
    .btn.leave{background:#ef4444; color:#fff; border-color:#b91c1c}
    .btn.complete{background:#10b981; color:#083b2b; border-color:#0e9f6e}
    .btn.disabled, .btn:disabled{opacity:.55; pointer-events:none}

    .empty{
      background:var(--paper); border:1px dashed var(--border); color:#6b7280; padding:18px; text-align:center; border-radius:14px
    }

    /* Phone-first polish */
    @media (max-width: 480px){
      .grid{ grid-template-columns: 1fr; }
      .hero .subtitle{ font-size: .95rem; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Playground</h1>
    <a href="index.html" aria-label="Back to Home"><i class="fa-solid fa-cards-blank"></i> Back</a>
  </div>

  <div class="layout">
    <!-- Intro / Description -->
    <div class="hero" role="region" aria-label="Playground introduction">
      <h2 class="title">Playground</h2>
      <p class="subtitle">
        Listing all Programs/ Activities/ Events.. available for different customer segment<br>
        Life is a playground, and inside it are countless experiences waiting for you to explore.
        Challenges, missions, activities — each one is a chance to experiment, to step outside your
        comfort zone, to try and to discover.<br>
        Here, you are free to explore, to stumble, to rise — because every attempt is a building block.
      </p>

      <div class="stats" aria-label="Your activity stats">
        <div id="statSelected" class="stat"><i class="fa-solid fa-hashtag"></i><span>Selected: 0 / 3</span></div>
        <div id="statOngoing" class="stat"><i class="fa-solid fa-play"></i><span>Ongoing: 0</span></div>
        <div id="statCompleted" class="stat"><i class="fa-solid fa-flag-checkered"></i><span>Completed: 0</span></div>
        <div id="statMissed" class="stat"><i class="fa-solid fa-circle-xmark"></i><span>Missed: 0</span></div>
        <div id="statOpen" class="stat"><i class="fa-solid fa-unlock"></i><span>Open: 0</span></div>
      </div>
    </div>

    <!-- Ongoing -->
    <section class="section" aria-labelledby="ongoing-title">
      <h3 id="ongoing-title"><i class="sec-ico fa-solid fa-play"></i> Ongoing (max 3)</h3>
      <div id="ongoingGrid" class="grid"></div>
      <div id="ongoingEmpty" class="empty" style="display:none;">No ongoing activities right now.</div>
    </section>

    <!-- Completed (user-completed only) -->
    <section class="section" aria-labelledby="completed-title">
      <h3 id="completed-title"><i class="sec-ico fa-solid fa-flag-checkered"></i> Completed</h3>
      <div id="completedGrid" class="grid"></div>
      <div id="completedEmpty" class="empty" style="display:none;">Nothing completed yet — keep going!</div>
    </section>

    <!-- Missed (time over, not completed) -->
    <section class="section" aria-labelledby="missed-title">
      <h3 id="missed-title"><i class="sec-ico fa-solid fa-circle-xmark"></i> Missed</h3>
      <div id="missedGrid" class="grid"></div>
      <div id="missedEmpty" class="empty" style="display:none;">No missed activities — nice!</div>
    </section>

    <!-- Open -->
    <section class="section" aria-labelledby="open-title">
      <h3 id="open-title"><i class="sec-ico fa-solid fa-unlock"></i> Open Activities</h3>
      <div id="openGrid" class="grid"></div>
      <div id="openEmpty" class="empty" style="display:none;">No open activities at the moment.</div>
    </section>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref as dbRef, get, set, update, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    // --- Firebase init ---
    const firebaseConfig = {
      apiKey: "AIzaSyBEIGffCj6b7RTU0hjW8Z4BXlrzFVZFL-s",
      authDomain: "nfc-cards-dfa6b.firebaseapp.com",
      projectId: "nfc-cards-dfa6b",
      storageBucket: "nfc-cards-dfa6b.appspot.com",
      messagingSenderId: "321725769305",
      appId: "1:321725769305:web:42e79fd85cc6029b97f348",
      databaseURL: "https://nfc-cards-dfa6b-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- Auth gate ---
    let UID = null;
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.replace('login.html');
        return;
      }
      UID = user.uid;
      bootstrap();
    });

    // --- DOM targets ---
    const ongoingGrid = document.getElementById('ongoingGrid');
    const completedGrid = document.getElementById('completedGrid');
    const missedGrid = document.getElementById('missedGrid');
    const openGrid = document.getElementById('openGrid');

    const ongoingEmpty = document.getElementById('ongoingEmpty');
    const completedEmpty = document.getElementById('completedEmpty');
    const missedEmpty = document.getElementById('missedEmpty');
    const openEmpty = document.getElementById('openEmpty');

    const statSelected = document.getElementById('statSelected').querySelector('span');
    const statOngoing = document.getElementById('statOngoing').querySelector('span');
    const statCompleted = document.getElementById('statCompleted').querySelector('span');
    const statMissed = document.getElementById('statMissed').querySelector('span');
    const statOpen = document.getElementById('statOpen').querySelector('span');

    // --- State ---
    let activities = [];
    let selected = new Set();   // ids user joined
    let completed = new Set();  // ids user completed

    // --- Time helpers (Asia/Singapore) ---
    const parseISO = (s) => new Date(s + 'T00:00:00'); // local day start
    const todaySG = () => {
      const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Singapore', year:'numeric', month:'2-digit', day:'2-digit' });
      return parseISO(fmt.format(new Date()));
    };

    // Global timing (independent of user)
    // returns 'open' | 'ongoing' | 'over'
    function globalTiming(a) {
      const now = todaySG();
      const start = parseISO(a.startDate);
      const end = parseISO(a.endDate);
      if (now >= end) return 'over';
      if (now >= start && now < end) return 'ongoing';
      return 'open';
    }

    const fmtRange = (a) => `${a.startDate} → ${a.endDate}`;

    // --- User state ---
    async function loadUserState() {
      const selSnap = await get(dbRef(db, `users/${UID}/playground/selected`));
      const compSnap = await get(dbRef(db, `users/${UID}/playground/completed`));
      selected = new Set(Object.keys(selSnap.val() || {}));
      completed = new Set(Object.keys(compSnap.val() || {}));
    }

    // --- Writes with guard ---
    async function joinActivity(activity) {
      // cap: 3 (fresh check)
      const selRef = dbRef(db, `users/${UID}/playground/selected`);
      const snap = await get(selRef);
      const cur = snap.val() || {};
      const already = !!cur[activity.id];
      const count = Object.keys(cur).length;

      if (!already && count >= 3) {
        alert('You can only select up to 3 activities.');
        return false;
      }
      // cannot join if time is already over
      if (globalTiming(activity) === 'over') {
        alert('This activity has ended.');
        return false;
      }

      await update(selRef, { [activity.id]: { joinedAt: Date.now(), name: activity.name } });
      selected.add(activity.id);
      return true;
    }

    async function leaveActivity(activityId) {
      await set(dbRef(db, `users/${UID}/playground/selected/${activityId}`), null);
      selected.delete(activityId);
    }

    async function markCompleted(activityId) {
      // Only allow manual completion while ongoing (not after over)
      const a = activities.find(x => x.id === activityId);
      if (!a) return;
      if (globalTiming(a) !== 'ongoing') {
        alert('You can only complete while the activity is ongoing.');
        return;
      }
      await set(dbRef(db, `users/${UID}/playground/completed/${activityId}`), {
        completedAt: Date.now(), auto: false
      });
      completed.add(activityId);
    }

    // --- Card factory ---
    function card(a) {
      const timing = globalTiming(a);                 // 'open' | 'ongoing' | 'over'
      const isSelected = selected.has(a.id);
      const isCompleted = completed.has(a.id);

      // Badge label + chip color
      let badgeIcon = 'fa-unlock';
      let badgeText = 'open';
      let chipClass = 'orange';

      if (isCompleted) {
        badgeIcon = 'fa-flag-checkered';
        badgeText = 'completed';
        chipClass = 'green';
      } else if (timing === 'ongoing') {
        badgeIcon = 'fa-play';
        badgeText = isSelected ? 'in progress' : 'ongoing';
        chipClass = 'blue';
      } else if (timing === 'over') {
        badgeIcon = 'fa-circle-xmark';
        badgeText = 'missed';
        chipClass = 'red';
      }

      const el = document.createElement('div');
      el.className = 'card';

      const poster = document.createElement('div');
      poster.className = 'poster';
      if (a.cover) {
        const img = document.createElement('img');
        img.src = a.cover;           // supports URLs or local paths
        img.alt = a.name;
        img.loading = 'lazy';
        img.referrerPolicy = 'no-referrer';
        poster.appendChild(img);
      }

      const b = document.createElement('div');
      b.className = 'badge';
      b.innerHTML = `<i class="fa-solid ${badgeIcon}"></i> ${badgeText}`;
      poster.appendChild(b);

      const content = document.createElement('div');
      content.className = 'content';

      const h = document.createElement('h4');
      h.className = 'title';
      h.textContent = a.name;

      const meta = document.createElement('div');
      meta.className = 'row';
      const d = document.createElement('span');
      d.className = 'chip';
      d.textContent = fmtRange(a);
      const stChip = document.createElement('span');
      stChip.className = `chip ${chipClass}`;
      stChip.textContent = isCompleted ? 'completed' : (timing === 'over' ? 'missed' : (timing === 'ongoing' ? (isSelected ? 'in progress' : 'ongoing') : 'open'));
      meta.appendChild(d);
      meta.appendChild(stChip);

      const actions = document.createElement('div');
      actions.className = 'actions';

      // Join (only if not selected, not completed, and not over)
      const btnJoin = document.createElement('button');
      btnJoin.className = 'btn join';
      btnJoin.innerHTML = '<i class="fa-solid fa-plus"></i> Join';
      btnJoin.style.display = (!isSelected && !isCompleted && timing !== 'over') ? 'inline-flex' : 'none';
      if (!isSelected && timing !== 'over' && selected.size >= 3) {
        btnJoin.classList.add('disabled'); btnJoin.disabled = true; btnJoin.title = 'Maximum 3 selected';
      }
      btnJoin.addEventListener('click', async () => {
        const ok = await joinActivity(a);
        if (ok) renderAll();
      });

      // Leave (only if selected and not completed)
      const btnLeave = document.createElement('button');
      btnLeave.className = 'btn leave';
      btnLeave.innerHTML = '<i class="fa-solid fa-xmark"></i> Leave';
      btnLeave.style.display = (isSelected && !isCompleted) ? 'inline-flex' : 'none';
      btnLeave.addEventListener('click', async () => {
        await leaveActivity(a.id);
        renderAll();
      });

      // Complete (only if selected, not completed, and timing is ongoing)
      const btnComplete = document.createElement('button');
      btnComplete.className = 'btn complete';
      btnComplete.innerHTML = '<i class="fa-solid fa-check"></i> Complete';
      btnComplete.style.display = (isSelected && !isCompleted && timing === 'ongoing') ? 'inline-flex' : 'none';
      btnComplete.addEventListener('click', async () => {
        await markCompleted(a.id);
        renderAll();
      });

      actions.appendChild(btnJoin);
      actions.appendChild(btnLeave);
      actions.appendChild(btnComplete);

      content.appendChild(h);
      content.appendChild(meta);
      content.appendChild(actions);

      el.appendChild(poster);
      el.appendChild(content);
      return el;
    }

    // --- Render ---
    function renderAll() {
      const ongoing = [];
      const done = [];
      const missed = [];
      const open = [];

      for (const a of activities) {
        const timing = globalTiming(a);     // 'open' | 'ongoing' | 'over'
        const isSelected = selected.has(a.id);
        const isCompleted = completed.has(a.id);

        if (isCompleted) {
          done.push(a);
        } else if (timing === 'over') {
          // time ended & user didn't complete -> missed
          missed.push(a);
        } else if (timing === 'ongoing') {
          // show in ongoing only if user has joined; otherwise it's available under open
          if (isSelected) ongoing.push(a); else open.push(a);
        } else {
          // timing === 'open'
          open.push(a);
        }
      }

      // Ongoing (max 3 shown)
      ongoingGrid.innerHTML = '';
      ongoing.slice(0,3).forEach(a => ongoingGrid.appendChild(card(a)));
      ongoingEmpty.style.display = ongoing.slice(0,3).length ? 'none' : 'block';

      // Completed (user-completed only)
      completedGrid.innerHTML = '';
      done.forEach(a => completedGrid.appendChild(card(a)));
      completedEmpty.style.display = done.length ? 'none' : 'block';

      // Missed (ended & not completed)
      missedGrid.innerHTML = '';
      missed.forEach(a => missedGrid.appendChild(card(a)));
      missedEmpty.style.display = missed.length ? 'none' : 'block';

      // Open
      openGrid.innerHTML = '';
      open.forEach(a => openGrid.appendChild(card(a)));
      openEmpty.style.display = open.length ? 'none' : 'block';

      // Stats
      const ongoingShown = Math.min(ongoing.length, 3);
      statSelected.textContent = `Selected: ${selected.size} / 3`;
      statOngoing.textContent = `Ongoing: ${ongoingShown}`;
      statCompleted.textContent = `Completed: ${done.length}`;
      statMissed.textContent = `Missed: ${missed.length}`;
      statOpen.textContent = `Open: ${open.length}`;
    }

    // --- Boot ---
    async function bootstrap() {
      // Load JSON list
      let res;
      try {
        res = await fetch('activities.json', { cache: 'no-store' });
      } catch (e) {
        console.error('Failed to load activities.json', e);
      }
      activities = (res && res.ok) ? await res.json() : [];

      // Load user state
      await loadUserState();

      // Live updates
      onValue(dbRef(db, `users/${UID}/playground/selected`), (snap) => {
        const v = snap.val() || {};
        selected = new Set(Object.keys(v));
        renderAll();
      });
      onValue(dbRef(db, `users/${UID}/playground/completed`), (snap) => {
        const v = snap.val() || {};
        completed = new Set(Object.keys(v));
        renderAll();
      });

      renderAll();
    }
  </script>
</body>
</html>
