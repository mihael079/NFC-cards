<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Playground – Activities</title>
  <meta name="theme-color" content="#ffbe3c" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --gold:#ffbe3c;
      --brown:#5d4037;
      --ink:#2a2a2a;
      --cream:#fff8e1;
      --paper:#fffdf5;
      --border:#efe7da;
      --soft-shadow:0 10px 30px rgba(0,0,0,.10);
      --soft-2:0 6px 18px rgba(0,0,0,.08);

      /* Chips */
      --chip-blue:#e3f2fd;
      --chip-green:#e7f6ea;
      --chip-orange:#fff3e0;
      --chip-gray:#f3f4f6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(135deg, var(--cream), #fdebe6);
      color:var(--ink);
      -webkit-tap-highlight-color: transparent;
    }

    .topbar{
      position: sticky; top: 0; z-index: 5;
      background: linear-gradient(180deg, var(--gold), #ffc84d);
      color: #3f2f2a;
      box-shadow: var(--soft-shadow);
      padding: 10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .topbar h1{margin:0; font-size:1.1rem; font-weight:900; letter-spacing:.2px}
    .topbar a{color:#3f2f2a; text-decoration:none; font-weight:800}
    .layout{max-width:1100px; margin:16px auto; padding:16px}

    .hero{
      background: radial-gradient(120% 120% at 50% -10%, #fff3d4 0%, #ffe9b3 55%, var(--gold) 100%);
      border-radius:20px; padding:18px; box-shadow: var(--soft-shadow);
    }
    .hero h2{margin:0 0 6px}
    .stats{display:flex; gap:10px; flex-wrap:wrap}
    .stat{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 12px; box-shadow: var(--soft-2);
      font-weight:800; color:#4b5563; display:flex; align-items:center; gap:8px;
    }

    .section{margin-top:18px}
    .section h3{margin:0 0 10px; font-size:1.05rem; font-weight:900; color:#3f2f2a}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }

    .card{
      background:#fff; border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow: var(--soft-2);
      display:flex; flex-direction:column; min-height: 260px;
    }
    .poster{
      position:relative; height:140px; background:linear-gradient(135deg, #ffe7c1, #ffd78a);
      display:grid; place-items:center; color:#3b2f2a;
    }
    .poster img{width:100%; height:100%; object-fit:cover; display:block}
    .badge{
      position:absolute; top:10px; left:10px;
      background:#000000a0; color:#fff; font-weight:800; font-size:.75rem; padding:6px 8px; border-radius:999px;
      display:flex; gap:6px; align-items:center;
    }
    .content{padding:12px 14px; display:flex; flex-direction:column; gap:8px; flex:1}
    .title{font-weight:900; font-size:1.02rem; color:#3f2f2a; margin:0}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      font-size:.8rem; font-weight:800; padding:6px 8px; border-radius:999px;
      background:var(--chip-gray); color:#374151; border:1px solid #e5e7eb;
    }
    .chip.green{background:var(--chip-green); color:#14532d; border-color:#cde7d4}
    .chip.orange{background:var(--chip-orange); color:#8a3d00; border-color:#ffd6a6}
    .chip.blue{background:var(--chip-blue); color:#0b5394; border-color:#cfe4fb}

    .actions{display:flex; gap:8px; margin-top:auto}
    .btn{
      flex:1; min-height:40px; border-radius:12px; border:2px solid #00000012;
      background:#fff; color:#333; font-weight:900; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition: transform .1s ease, box-shadow .2s ease;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 8px 16px rgba(0,0,0,.12)}
    .btn.join{background:#1e88e5; color:#fff; border-color:#1669b5}
    .btn.leave{background:#ef4444; color:#fff; border-color:#b91c1c}
    .btn.complete{background:#10b981; color:#083b2b; border-color:#0e9f6e}
    .btn.disabled, .btn:disabled{opacity:.55; pointer-events:none}

    .empty{
      background:var(--paper); border:1px dashed var(--border); color:#6b7280; padding:18px; text-align:center; border-radius:14px
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Playground</h1>
    <a href="index.html"><i class="fa-solid fa-cards-blank"></i> Back</a>
  </div>

  <div class="layout">
    <div class="hero">
      <h2>Choose. Focus. Grow.</h2>
      <div class="stats">
        <div id="statSelected" class="stat"><i class="fa-solid fa-hashtag"></i><span>Selected: 0 / 3</span></div>
        <div id="statOngoing" class="stat"><i class="fa-solid fa-play"></i><span>Ongoing: 0</span></div>
        <div id="statCompleted" class="stat"><i class="fa-solid fa-flag-checkered"></i><span>Completed: 0</span></div>
        <div id="statOpen" class="stat"><i class="fa-solid fa-unlock"></i><span>Open: 0</span></div>
      </div>
    </div>

    <!-- Ongoing -->
    <section class="section" aria-labelledby="ongoing-title">
      <h3 id="ongoing-title">Ongoing (max 3)</h3>
      <div id="ongoingGrid" class="grid"></div>
      <div id="ongoingEmpty" class="empty" style="display:none;">No ongoing activities right now.</div>
    </section>

    <!-- Completed -->
    <section class="section" aria-labelledby="completed-title">
      <h3 id="completed-title">Completed</h3>
      <div id="completedGrid" class="grid"></div>
      <div id="completedEmpty" class="empty" style="display:none;">Nothing completed yet — keep going!</div>
    </section>

    <!-- Open -->
    <section class="section" aria-labelledby="open-title">
      <h3 id="open-title">Open Activities</h3>
      <div id="openGrid" class="grid"></div>
      <div id="openEmpty" class="empty" style="display:none;">No open activities at the moment.</div>
    </section>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref as dbRef, get, set, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    // --- Firebase init ---
    const firebaseConfig = {
      apiKey: "AIzaSyBEIGffCj6b7RTU0hjW8Z4BXlrzFVZFL-s",
      authDomain: "nfc-cards-dfa6b.firebaseapp.com",
      projectId: "nfc-cards-dfa6b",
      storageBucket: "nfc-cards-dfa6b.appspot.com",
      messagingSenderId: "321725769305",
      appId: "1:321725769305:web:42e79fd85cc6029b97f348",
      databaseURL: "https://nfc-cards-dfa6b-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- Auth gate ---
    let UID = null;
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.replace('login.html');
        return;
      }
      UID = user.uid;
      bootstrap();
    });

    // --- DOM targets ---
    const ongoingGrid = document.getElementById('ongoingGrid');
    const completedGrid = document.getElementById('completedGrid');
    const openGrid = document.getElementById('openGrid');
    const ongoingEmpty = document.getElementById('ongoingEmpty');
    const completedEmpty = document.getElementById('completedEmpty');
    const openEmpty = document.getElementById('openEmpty');

    const statSelected = document.getElementById('statSelected').querySelector('span');
    const statOngoing = document.getElementById('statOngoing').querySelector('span');
    const statCompleted = document.getElementById('statCompleted').querySelector('span');
    const statOpen = document.getElementById('statOpen').querySelector('span');

    // --- State ---
    let activities = [];
    let selected = new Set();
    let completed = new Set();

    // --- Helpers ---
    const parseISO = (s) => new Date(s + 'T00:00:00'); // treat as local day start
    const today = () => {
      // Asia/Singapore date (YYYY-MM-DD) -> Date
      const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Singapore', year:'numeric', month:'2-digit', day:'2-digit' });
      const ymd = fmt.format(new Date()); // e.g. 2025-09-16
      return parseISO(ymd);
    };

    function statusFor(activity, userCompleted) {
      const now = today();
      const start = parseISO(activity.startDate);
      const end = parseISO(activity.endDate);
      if (userCompleted) return 'completed';
      if (now >= end) return 'completed';
      if (now >= start && now < end) return 'ongoing';
      return 'open';
    }

    function fmtRange(a) {
      return `${a.startDate} → ${a.endDate}`;
    }

    function cap(n, max) { return n > max ? max : n; }

    // --- Firebase read/write ---
    async function loadUserState() {
      const selSnap = await get(dbRef(db, `users/${UID}/playground/selected`));
      const compSnap = await get(dbRef(db, `users/${UID}/playground/completed`));

      selected = new Set(Object.keys(selSnap.val() || {}).filter(k => selSnap.val()[k]));
      completed = new Set(Object.keys(compSnap.val() || {}).filter(k => compSnap.val()[k]));
    }

    async function setSelected(activityId, value) {
      if (value) {
        if (selected.size >= 3 && !selected.has(activityId)) {
          alert('You can only select up to 3 activities.');
          return false;
        }
        await update(dbRef(db, `users/${UID}/playground/selected`), { [activityId]: true });
        selected.add(activityId);
      } else {
        await update(dbRef(db, `users/${UID}/playground/selected`), { [activityId]: null });
        selected.delete(activityId);
        // Optional: do not auto-remove completed flag; leave history
      }
      return true;
    }

    async function setCompleted(activityId, value) {
      if (value) {
        await update(dbRef(db, `users/${UID}/playground/completed`), { [activityId]: true });
        completed.add(activityId);
      } else {
        await update(dbRef(db, `users/${UID}/playground/completed`), { [activityId]: null });
        completed.delete(activityId);
      }
    }

    // --- Rendering ---
    function card(a) {
      const userCompleted = completed.has(a.id);
      const st = statusFor(a, userCompleted);
      const isSelected = selected.has(a.id);

      const card = document.createElement('div');
      card.className = 'card';

      const poster = document.createElement('div');
      poster.className = 'poster';
      if (a.cover) {
        const img = document.createElement('img');
        img.src = a.cover;
        img.alt = a.name;
        poster.appendChild(img);
      } else {
        poster.innerHTML = `<i class="fa-solid fa-shapes" style="font-size:28px;"></i>`;
      }

      const b = document.createElement('div');
      b.className = 'badge';
      b.innerHTML = `<i class="fa-solid ${st==='completed'?'fa-flag-checkered':(st==='ongoing'?'fa-play':'fa-unlock')}"></i> ${st}`;
      poster.appendChild(b);

      const content = document.createElement('div');
      content.className = 'content';

      const h = document.createElement('h4');
      h.className = 'title';
      h.textContent = a.name;

      const meta = document.createElement('div');
      meta.className = 'row';
      const d = document.createElement('span');
      d.className = 'chip';
      d.textContent = fmtRange(a);
      const stChip = document.createElement('span');
      stChip.className = 'chip ' + (st==='completed'?'green':(st==='ongoing'?'blue':'orange'));
      stChip.textContent = st;
      meta.appendChild(d);
      meta.appendChild(stChip);

      const actions = document.createElement('div');
      actions.className = 'actions';

      // Buttons logic:
      // Join: visible when not selected and status is not completed; disabled if already have 3 selections
      // Leave: visible when selected
      // Complete: visible when selected and not auto-completed & not user-completed
      const btnJoin = document.createElement('button');
      btnJoin.className = 'btn join';
      btnJoin.innerHTML = '<i class="fa-solid fa-plus"></i> Join';
      btnJoin.style.display = (!isSelected && st!=='completed') ? 'inline-flex' : 'none';
      if (!isSelected && st!=='completed' && selected.size >= 3) {
        btnJoin.classList.add('disabled');
        btnJoin.disabled = true;
        btnJoin.title = 'Maximum 3 selected';
      }
      btnJoin.addEventListener('click', async () => {
        const ok = await setSelected(a.id, true);
        if (ok) renderAll();
      });

      const btnLeave = document.createElement('button');
      btnLeave.className = 'btn leave';
      btnLeave.innerHTML = '<i class="fa-solid fa-xmark"></i> Leave';
      btnLeave.style.display = isSelected ? 'inline-flex' : 'none';
      btnLeave.addEventListener('click', async () => {
        await setSelected(a.id, false);
        renderAll();
      });

      const autoCompleted = (statusFor(a, false) === 'completed'); // completed by date (ignoring per-user flag)
      const alreadyCompleted = userCompleted || autoCompleted;

      const btnComplete = document.createElement('button');
      btnComplete.className = 'btn complete';
      btnComplete.innerHTML = '<i class="fa-solid fa-check"></i> Complete';
      btnComplete.style.display = (isSelected && !alreadyCompleted) ? 'inline-flex' : 'none';
      btnComplete.addEventListener('click', async () => {
        await setCompleted(a.id, true);
        renderAll();
      });

      actions.appendChild(btnJoin);
      actions.appendChild(btnLeave);
      actions.appendChild(btnComplete);

      content.appendChild(h);
      content.appendChild(meta);
      content.appendChild(actions);

      card.appendChild(poster);
      card.appendChild(content);
      return card;
    }

    function renderAll() {
      // Partition by status (per-user)
      const ongoing = [];
      const done = [];
      const open = [];

      for (const a of activities) {
        const st = statusFor(a, completed.has(a.id));
        if (st === 'completed') {
          // Only show in completed if the user had selected it OR it auto-completed globally?
          // We’ll show completed if user selected it OR date completed. Keeps history and clarity.
          done.push(a);
        } else if (st === 'ongoing') {
          // Ongoing only meaningful if selected
          if (selected.has(a.id)) ongoing.push(a);
          else open.push(a);
        } else {
          // open
          open.push(a);
        }
      }

      // Ongoing: show max 3
      ongoingGrid.innerHTML = '';
      ongoing.slice(0,3).forEach(a => ongoingGrid.appendChild(card(a)));
      ongoingEmpty.style.display = ongoing.slice(0,3).length ? 'none' : 'block';

      // Completed
      completedGrid.innerHTML = '';
      done.forEach(a => completedGrid.appendChild(card(a)));
      completedEmpty.style.display = done.length ? 'none' : 'block';

      // Open
      openGrid.innerHTML = '';
      open.forEach(a => openGrid.appendChild(card(a)));
      openEmpty.style.display = open.length ? 'none' : 'block';

      // Stats
      statSelected.textContent = `Selected: ${selected.size} / 3`;
      statOngoing.textContent = `Ongoing: ${ongoing.length > 3 ? 3 : ongoing.length}`;
      statCompleted.textContent = `Completed: ${done.length}`;
      statOpen.textContent = `Open: ${open.length}`;
    }

    async function bootstrap() {
      // Load JSON list
      const res = await fetch('activities.json', { cache: 'no-store' });
      activities = await res.json();

      // Load user state
      await loadUserState();

      // Live updates (optional) – if you want instant sync across tabs:
      onValue(dbRef(db, `users/${UID}/playground/selected`), (snap) => {
        const v = snap.val() || {};
        selected = new Set(Object.keys(v).filter(k => v[k]));
        renderAll();
      });
      onValue(dbRef(db, `users/${UID}/playground/completed`), (snap) => {
        const v = snap.val() || {};
        completed = new Set(Object.keys(v).filter(k => v[k]));
        renderAll();
      });

      renderAll();
    }
  </script>
</body>
</html>
